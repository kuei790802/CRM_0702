<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端登入與購物車測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 600px;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* 導覽列 */
        .navbar {
            width: 100%;
            background-color: #333;
            padding: 10px 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            box-sizing: border-box;
        }
        .navbar .user-info {
            display: none; /* 預設隱藏 */
        }
        .navbar .cart-button {
            background-color: #007bff;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .navbar .cart-button:hover {
            background-color: #0056b3;
        }
        .navbar .logout-button {
            background-color: #dc3545;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        .main-content {
            margin-top: 80px; /* 留出 navbar 的空間 */
            width: 100%;
        }
        /* 登入區塊 */
        #login-section {
            display: block;
        }
        h2 {
            text-align: center;
            color: #333;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #218838;
        }
        /* 購物車顯示區塊 */
        #cart-section {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        #cart-details {
            white-space: pre-wrap; /* 讓 JSON 格式正確換行顯示 */
            background-color: #e9e9e9;
            padding: 15px;
            border-radius: 4px;
            word-wrap: break-word;
        }
        .error-message {
            color: red;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="navbar">
    <div class="brand">測試網站</div>
    <div class="user-info" id="user-info">
        <span id="welcome-message"></span>
        <button class="cart-button" id="view-cart-button">查看購物車</button>
        <button class="logout-button" id="logout-button">登出</button>
    </div>
</div>

<div class="main-content">
    <div class="container" id="login-section">
        <h2>會員登入</h2>
        <div class="form-group">
            <label for="account">帳號</label>
            <input type="text" id="account" name="account" value="testuser1">
        </div>
        <div class="form-group">
            <label for="password">密碼</label>
            <input type="password" id="password" name="password" value="password123">
        </div>
        <button id="login-button">登入</button>
        <div class="error-message" id="login-error"></div>
    </div>

    <div class="container" id="cart-section">
        <h2>您的購物車內容</h2>
        <div id="cart-details">... 點擊按鈕後，這裡會顯示購物車資料 ...</div>
        <div class="error-message" id="cart-error"></div>
    </div>
</div>

<script>
    // DOM 元素
    const loginSection = document.getElementById('login-section');
    const cartSection = document.getElementById('cart-section');
    const userInfo = document.getElementById('user-info');
    const welcomeMessage = document.getElementById('welcome-message');
    const loginButton = document.getElementById('login-button');
    const viewCartButton = document.getElementById('view-cart-button');
    const logoutButton = document.getElementById('logout-button');
    const cartDetails = document.getElementById('cart-details');
    const loginError = document.getElementById('login-error');
    const cartError = document.getElementById('cart-error');

    // 頁面初始化時，檢查是否已有 token
    window.onload = function() {
        const token = localStorage.getItem('jwtToken');
        if (token) {
            try {
                // 從 JWT 中解析出 payload 來取得帳號資訊 (簡易版，不驗證簽章)
                const payload = JSON.parse(atob(token.split('.')[1]));
                updateUIForLoggedIn(payload.sub); // payload.sub 就是帳號
            } catch (e) {
                // 如果 token 格式不對，就登出
                handleLogout();
            }
        }
    };

    // 更新 UI 為登入狀態
    function updateUIForLoggedIn(account) {
        loginSection.style.display = 'none';
        userInfo.style.display = 'flex';
        welcomeMessage.textContent = `歡迎, ${account}!`;
    }

    // 更新 UI 為登出狀態
    function updateUIForLoggedOut() {
        loginSection.style.display = 'block';
        userInfo.style.display = 'none';
        cartSection.style.display = 'none';
        loginError.textContent = '';
        cartError.textContent = '';
    }

    /**
     * 處理登入按鈕點擊事件
     */
    async function handleLogin() {
        const accountInput = document.getElementById('account').value;
        const passwordInput = document.getElementById('password').value;
        loginError.textContent = ''; // 清空錯誤訊息

        try {
            // ★★★ 注意：後端 API 路徑要跟你的一致 ★★★
            const response = await fetch('/customer/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    account: accountInput,
                    password: passwordInput,
                }),
            });

            const data = await response.json();

            if (response.ok && data.token) {
                // 將 token 存入 localStorage
                localStorage.setItem('jwtToken', data.token);
                // 更新 UI
                updateUIForLoggedIn(data.account);
            } else {
                // 登入失敗
                const errorMessage = data.message || '登入失敗，請檢查帳號密碼。';
                loginError.textContent = errorMessage;
            }
        } catch (error) {
            console.error('Login request failed:', error);
            loginError.textContent = '登入請求失敗，請檢查網路連線或後端服務。';
        }
    }

    /**
     * 獲取購物車資料
     */
    async function fetchCartData() {
        const token = localStorage.getItem('jwtToken');
        cartError.textContent = ''; // 清空錯誤訊息

        // 如果沒有 token，表示使用者未登入
        if (!token) {
            console.error('No token found, please login.');
            cartError.textContent = '您尚未登入，請先登入！';
            handleLogout(); // 強制登出
            return;
        }

        // 顯示購物車區塊並清空舊資料
        cartSection.style.display = 'block';
        cartDetails.textContent = '載入中...';

        try {
            // ★★★ 注意：後端 API 路徑要跟你修改後的一致 (沒有 userId) ★★★
            const response = await fetch('/api/cart', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    // 在這裡帶上 JWT
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const cartData = await response.json();
                console.log('Cart data:', cartData);
                // 將回傳的 JSON 美化後顯示
                cartDetails.textContent = JSON.stringify(cartData, null, 2);
            } else {
                console.error('Failed to fetch cart data:', response.status, response.statusText);
                const errorText = await response.text();
                cartError.textContent = `獲取購物車失敗: ${response.status} ${response.statusText}. \n錯誤訊息: ${errorText}`;
                // 如果是 401 或 403，可能表示 token 過期，需要重新登入
                if (response.status === 401 || response.status === 403) {
                    handleLogout(); // token 失效，執行登出
                }
            }
        } catch(error) {
            console.error('Fetch cart request failed:', error);
            cartError.textContent = '請求購物車資料時發生錯誤，請檢查網路或後端服務。';
        }
    }

    /**
     * 處理登出
     */
    function handleLogout() {
        localStorage.removeItem('jwtToken');
        updateUIForLoggedOut();
    }


    // 綁定事件監聽器
    loginButton.addEventListener('click', handleLogin);
    viewCartButton.addEventListener('click', fetchCartData);
    logoutButton.addEventListener('click', handleLogout);

</script>

</body>
</html>